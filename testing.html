---
layout: default
---
    <div class="mdl-grid">
      <div class="mdl-cell mdl-cell--12-col mdl-cell--8-col-tablet mdl-cell--4-col-phone center">
        <div class="mdl-card mdl-shadow--3dp mdl-color-text--black">
          <div class="mdl-card__supporting-text mdl-color-text--black">
            <h4 class="mdl-color-text--primary">Daily Bible Podcast</h4>
            <p>
              Hear and read the Bible daily using the resources on this page. Each day, a new reading 
              is pre-loaded using today's date and the default reading plan.
            </p>
            <p>
              Easily switch days or change plans using the selection lists below. If you choose a new plan, 
              bookmark the page to pre-load that plan each time you visit.
            </p>
            <p>
              An auto-generated playlist of related "Read Scripture" videos from <a target="_blank" href="{{ site.baseurl }}bibleproject">The Bible Project</a>
              is also available to watch in the "Related Videos" section.
            </p>
          </div>
        </div> 
      </div>
      <div class="mdl-cell mdl-cell--6-col mdl-cell--8-col-tablet mdl-cell--4-col-phone center">
        <div class="mdl-card mdl-shadow--3dp mdl-color-text--black">
          <div class="mdl-card__supporting-text mdl-color-text--primary">
            <table>
              <tr>
                <td class="lead">
                  <strong>Plan Name:</strong>
                </td>
              </tr>
              <tr>
                <td id="plan_description"></td>
              </tr>
              <tr>
                <td class="lead">
                  <strong>Plan Day:</strong>
                </td>
              </tr>
              <tr>
                <td id="day_selected"></td>
              </tr>
              <tr>
                <td class="lead">
                    <strong>Readings:</strong>
                </td>
              </tr>
              <tr>
                <td id="readings"></td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <div class="mdl-cell mdl-cell--6-col mdl-cell--8-col-tablet mdl-cell--4-col-phone">
        <div class="mdl-card mdl-shadow--3dp mdl-color-text--primary">
          <div class="mdl-card__supporting-text mdl-color-text--primary">
            <h4>Load New Day or Plan</h4>
            <form>
              <label style="font-size: 16px" for="datepicker">Date/Day:</label><br />
              <input type="date" id="datepicker" required pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}">
              <!-- Accent-colored raised button with ripple -->
              <!-- Colored FAB button -->
              <button id="submit_date" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--fab">
                  <i class="material-icons">input</i>
              </button>
            </form>
            <!-- Choose Different Bible Plan and Version Combination -->
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <select class="mdl-textfield__input" id="plan_selection" name="plan_selection" style="width: 200px">
                <option></option>
                <optgroup label="Entire Bible in 365 days">
                  {% for plan in site.data.picklist %}
                    {% if plan.type == "365_whole_bible" %}
                    <option value="{{plan.name}}">{{plan.description}} ({{plan.version}})</option>
                    {% endif %}
                  {% endfor %}
                </optgroup>
                <optgroup label="Entire Bible in 90 days">
                  {% for plan in site.data.picklist %}
                    {% if plan.type == "90_whole_bible" %}
                    <option value="{{plan.name}}">{{plan.description}} ({{plan.version}})</option>
                    {% endif %}
                  {% endfor %}
                </optgroup>
                <optgroup label="Other Daily Reading Options">
                  {% for plan in site.data.picklist %}
                    {% if plan.type == "365_partial_bible" %}
                    <option value="{{plan.name}}">{{plan.description}} ({{plan.version}})</option>
                    {% endif %}
                  {% endfor %}
                </optgroup>
              </select>
              <label class="mdl-color-text--primary mdl-textfield__label" for="plan_selection">Reading Plan</label>
            </div>
          </div>
        </div>
      </div>
      <div class="mdl-cell mdl-cell--6-col mdl-cell--8-col-tablet mdl-cell--4-col-phone">
        <div class="mdl-card mdl-shadow--3dp">
          <div class="mdl-card__supporting-text center">
            <h4 id="audio_description">Daily Bible Podcast</h4>
          </div>
          <div style="position: relative">
            <video id="audio_refresh" playsinline controls preload="metadata" name="media">
              <source id="audio_url" type="audio/mp3">
            </video>
            <div class="overlay">
              <p id="audio_help_text" class="mdl-color-text--white">
                Tip: use the arrows in the top left corner to enter full screen mode and continue listening after navigating away from page.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="mdl-cell mdl-cell--6-col mdl-cell--8-col-tablet mdl-cell--4-col-phone">
        <div class="mdl-card mdl-shadow--3dp">
          <div class="mdl-card__supporting-text">
            <h4>Related Videos</h4>
          </div>
          <iframe id="bp_playlist" width="560" height="315" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
      </div>
      <div class="mdl-cell mdl-cell--12-col mdl-cell--8-col-tablet mdl-cell--4-col-phone">
          <div id="bg_readings_desktop" class="mdl-card mdl-shadow--3dp mdl-color-text--black">
            <div class="mdl-card__supporting-text">
                <h4>Daily Bible Reading</h4>
            </div>
            <div id="bg_progress" style="margin: 0 auto;"></div>
            <div id="replace_bible_text">
            </div>
          </div>
      </div>
    </div>

  <script type="text/javascript">
    // Get Day of Year
    Date.prototype.getDOY = function() {
      var dayCount = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
      var mn = this.getMonth();
      var dn = this.getDate();
      var dayOfYear = dayCount[mn] + dn;
      return dayOfYear;
    };

    getToday = function getToday () {
      let today = new Date();
      let dd = today.getDate();
      let mm = today.getMonth()+1; 
      let yyyy = today.getFullYear();
      if(dd<10) 
      {
          dd='0'+dd;
      } 
      if(mm<10) 
      {
          mm='0'+mm;
      }
      return `${yyyy}-${mm}-${dd}`;
    }

    removePassageAnnotation = function removePassageAnnotation (list) {
      let trimmed_list = [];
      let iterReadings = list[Symbol.iterator]();
      for (let item of iterReadings) {
        trimmed_list = trimmed_list.concat(item.split('[')[0].trim());
      }
      return trimmed_list;
    }

    // Retrieve variables from file and update DOM
    populateReadingByDay = function(day, daily_readings, daily_audio, bp_videos, plan_abbr, version_abbr) {

      // add spinner for bible passage
      let spinner_classes="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active";
      $( "#bg_progress" ).addClass(spinner_classes);

      // Get data that corresponds to current value of day
      console.log(`Selected Day is ${day}`);

      // Get list of Scriptures that corresponds to current value of day
      let original_readings = daily_readings['days'][day];
      console.log("Number of readings:");
      console.log(original_readings.length);

      let readings = removePassageAnnotation(original_readings);
      // Update UI
      document.getElementById('plan_description').innerHTML = `${daily_readings['plan_description']} (${daily_audio['version']})`;
      document.getElementById('readings').innerHTML = `${original_readings.join(', ')}`;
      document.getElementById('day_selected').innerHTML = `${day}`;

      // Build Bible Project ad hoc playlist URL from day readings
      var playlistIdsArr = [];
      var iterReadings = readings[Symbol.iterator]();
      console.log("Books in today's reading:");
      for (let reading of iterReadings) {
        var book = reading.split(' ')[0];
        console.log(book);
        playlistIdsArr = playlistIdsArr.concat(bp_videos.books[book]);
      }
      var playlistIds = playlistIdsArr.join(',');
      let bp_url = `https://www.youtube-nocookie.com/embed/VIDEO_ID?playlist=${playlistIds}`;
      document.getElementById('bp_playlist').src = bp_url;

      // Build Audio URL from day selected
      let audio_url = daily_audio['url'];
      // Create complete URL
      if ('days' in daily_audio) {
        audio_url = audio_url.replace("{var1}", daily_audio['days'][day]);
      } else {
        // assume esv
        let esvparam = esvaudio.processRef(readings.join(' '));
        console.log("ESV Parameters:");
        console.log(esvparam);
        audio_url = audio_url.replace("{var1}", esvparam[0]);
      }
      
      console.log(`Daily reading url: ${audio_url}`);
      // Update UI with audio
      document.getElementById('audio_url').src = audio_url;
      document.getElementById('audio_refresh').load();

      // Pass through CORS server to add required headers for cross origin resource
      let cors;
      cors = "https://more-power.herokuapp.com";
      //cors = "http://localhost:3000";

      // Build BST URL and retrieve reading text
      let query = `?q=${readings.join(';+').split(' ').join('+')}&t=${daily_audio['version']}`;
      console.log("BST query is:");
      console.log(query);

      let isOne = false;
      if (original_readings.length <= 1) isOne = true;

      $.ajax({
        type: 'POST',
        contentType: 'application/json',
        url: `${cors}/reqtesting/${plan_abbr}/${version_abbr}/${day}`,
        data: `{"page": "{{page.name}}", "plan": "${plan_abbr}", "version": "${version_abbr}","day": "${day}", "isOne": "${isOne}", "domain": "bst", "query": "${query}"}`,
        dataType: 'text',
        success: function(data) {
          // Finally, update UI
          $( "#bg_progress" ).removeClass(spinner_classes);
          $( "#replace_bible_text" ).html(data);
          return false; // prevents auto jump to top of page when ajax completes
        }
      });
    };
    
    $( document ).ready(function() {

      {% include onload_ping.html %}

      let all_readings = {{site.data.readings | jsonify}};
      let all_audio = {{site.data.audio | jsonify}};

      // Get URL query params if present
      var url_string = window.location;
      var url = new URL(url_string);
      var reading_plan = url.searchParams.get("plan");
      var bible_version = url.searchParams.get("version");
      console.log("reading plan and bible version");
      console.log(reading_plan);
      console.log(bible_version);

      let readings;
      let audio;
      // set vars conditionally based on URL params
      if (reading_plan && bible_version) {
        reading_plan = reading_plan.toLowerCase();
        bible_version = bible_version.toLowerCase();
        readings = all_readings[reading_plan];
        // audio contains two possible keys 'days' (dict) and 'url' (string)
        audio = all_audio[reading_plan][bible_version];
      } else {
        // defaults
        reading_plan = 'oyb';
        bible_version = 'nlt';
        readings = all_readings['oyb'];
        audio = all_audio['oyb']['nlt'];
      }
      console.log(readings);
      console.log(audio);
    
      // Set default value in input date. Today's date in format mm/dd/yyyy.
      let dateControl = document.querySelector('input[type="date"]');
      dateControl.value = getToday();
      // Get Bible Project metadata
      let bp_videos = {{site.data.bibleproject_lookup_by_book | jsonify}};
      // Get day
      let day = new Date().getDOY();
      console.log(day);
      // Add data for today
      populateReadingByDay(day, readings, audio, bp_videos, reading_plan, bible_version);

      $("#audio_refresh").on('play',function () {
        // apply to iOS only
        let iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (iOS) {
          $("#audio_help_text").show();
          setTimeout(function () {$("#audio_help_text").hide()}, 6000);
        }
      });

      $("#plan_selection").on("change", function (event) {
        let plan = $("#plan_selection option:selected").val();
        plan = plan.split('-');
        window.location.search = `plan=${plan[0]}&version=${plan[1]}`;
      });

      $("#submit_date").on("click", function (event) {
        event.preventDefault();
        var str = $("#datepicker").val();
        console.log(`Date submitted is: ${str}`);
        var year = str.substring(0, 4);
        var month = str.substring(5, 7);
        var day = str.substring(8, 10);
        var myDate = new Date(`${month}/${day}/${year}`);
        console.log(`Day selected: ${myDate}`);
        populateReadingByDay(myDate.getDOY(), readings, audio, bp_videos, reading_plan, bible_version);
        document.getElementById('audio_refresh').play();
      });
    });
  </script>